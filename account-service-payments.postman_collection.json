{
  "info": {
    "name": "Account Service - Payments",
    "_postman_id": "8f4a7d5b-d2a1-4b9a-9c6d-6b7d1c0f7a11",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:4000" },
    { "key": "tenantId", "value": "demo-tenant" },
    { "key": "apiKey", "value": "changeme" },
    { "key": "timestamp", "value": "1690000000000" },
    {
      "key": "idempotencyKey",
      "value": "{{tenantId}}:member-123:{{timestamp}}"
    },
    { "key": "paymentIntentId", "value": "pi_123" }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const ts = Date.now().toString();",
          "pm.variables.set('timestamp', ts);",
          "pm.variables.set('idempotencyKey', pm.variables.get('tenantId') + ':member-123:' + ts);"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Create Intent (PaymentIntent)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" },
          { "key": "x-idempotency-key", "value": "{{idempotencyKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"purpose\": \"subscriptionFee\",\n  \"amount\": 500,\n  \"currency\": \"eur\"\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/intents",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "intents"]
        }
      }
    },
    {
      "name": "Create Intent (Checkout)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" },
          { "key": "x-idempotency-key", "value": "{{idempotencyKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"purpose\": \"subscriptionFee\",\n  \"amount\": 500,\n  \"currency\": \"eur\",\n  \"useCheckout\": true\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/intents",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "intents"]
        }
      }
    },
    {
      "name": "Reconcile Stripe Event",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" },
          { "key": "x-idempotency-key", "value": "{{idempotencyKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"eventId\": \"evt_1\",\n  \"type\": \"payment_intent.succeeded\",\n  \"payment\": {\n    \"paymentIntentId\": \"{{paymentIntentId}}\",\n    \"amount\": 500,\n    \"currency\": \"eur\",\n    \"status\": \"succeeded\"\n  }\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/reconcile",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "reconcile"]
        }
      }
    },
    {
      "name": "Get by Stripe PaymentIntent",
      "request": {
        "method": "GET",
        "header": [
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" }
        ],
        "url": {
          "raw": "{{baseUrl}}/api/payments/by-stripe/{{paymentIntentId}}",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "by-stripe", "{{paymentIntentId}}"]
        }
      }
    },
    {
      "name": "Record External (In)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"direction\": \"in\",\n  \"amount\": 500,\n  \"currency\": \"eur\",\n  \"reason\": \"cash payment\"\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/record-external",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "record-external"]
        }
      }
    },
    {
      "name": "Record External (Out)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"direction\": \"out\",\n  \"amount\": 300,\n  \"currency\": \"eur\",\n  \"reason\": \"refund\"\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/record-external",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "record-external"]
        }
      }
    },
    {
      "name": "Create Refund (External)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" },
          { "key": "x-idempotency-key", "value": "{{idempotencyKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"mode\": \"external\",\n  \"amount\": 100,\n  \"reason\": \"manual\"\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/refunds",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "refunds"]
        }
      }
    },
    {
      "name": "Create Refund (Stripe)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "content-type", "value": "application/json" },
          { "key": "x-tenant-id", "value": "{{tenantId}}" },
          { "key": "x-api-key", "value": "{{apiKey}}" },
          { "key": "x-idempotency-key", "value": "{{idempotencyKey}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"mode\": \"stripe\",\n  \"paymentIntentId\": \"{{paymentIntentId}}\",\n  \"amount\": 100\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": {
          "raw": "{{baseUrl}}/api/payments/refunds",
          "host": ["{{baseUrl}}"],
          "path": ["api", "payments", "refunds"]
        }
      }
    }
  ]
}
